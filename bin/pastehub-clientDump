#!/usr/bin/env ruby
# -*- coding: utf-8 -*-

require 'pastehub'

def dumpDb( username, command, key )
  config = PasteHub::Config.instance
  config.loadClient

  # open local db
  localdb = PasteHub::LocalDB.new( config.localDbPath )
  localdb.open( username, true )

  case command
  when "list"
    localList = localdb.getList().reject{|x| x.match( /^_/ )}
    localList.each { |x|
      puts x
    }

  when "top"
    localList = localdb.getList().reject{|x| x.match( /^_/ )}
    if 0 < localList.size
      print localdb.getValue( localList.first )
    end

  when "latestdate"
    puts localdb.getValue( PasteHub::LATEST_DATE_KEY )

  when "get"
    print localdb.getValue( key )
  end
  localdb.close()
end

def main
  username  = ENV['PASTEHUB_USER']
  if not username 
    STDERR.puts "clientDump needs environment var `PASTEHUB_USER'"
    exit 1
  end

  if 0 == ARGV.length 
    STDERR.puts "clientDump [command] [arg]"
    STDERR.puts "  1) clientDump list"
    STDERR.puts "  2) clientDump get  key"
    STDERR.puts "  3) clientDump top"
    STDERR.puts "  4) clientDump latestdate"
    exit 1
  end

  command = ARGV[0].downcase
  case command
  when "list"
    dumpDb( username, command, "" )
  when "top"
    dumpDb( username, command, "" )
  when "latestdate"
    dumpDb( username, command, "" )
  when "get"
    if 2 > ARGV.length
      STDERR.puts "Error: please spacify key."
      exit 1
    end
    dumpDb( username, command, ARGV[1] )
  else
    STDERR.puts "unknown command [#{command}]"
  end
end

main

#!/usr/bin/env ruby
# -*- coding: utf-8 -*-

require 'net/http'
require 'uri'
require 'open-uri'
require 'fileutils'
require 'pastehub'

SERVER_HOST='localhost'
LOCALDB_PATH=File.expand_path( "~/.localdb/" ) + "/"

def getValue( auth, key )
  uri = URI.parse("http://#{SERVER_HOST}:8081/getValue")
  ret = ""
  Net::HTTP.start(uri.host, uri.port) do |http|
    http.post(uri.request_uri, key, auth.getAuthHash().merge( {"content-type" => "plain/text"} )) { |str|
      ret = str
    }
  end
  ret
end

def putValue( auth, key, value )
  uri = URI.parse("http://#{SERVER_HOST}:8081/putValue")
  ret = ""
  Net::HTTP.start(uri.host, uri.port) do |http|
    http.post(uri.request_uri, value,
              auth.getAuthHash().merge(
                                       { "content-type" => "plain/text",
                                         "x-pastehub-key" => key    }
                                       )) { |str|
      ret = str
    }
  end
  ret
end

def sync_db( auth )
  puts "synchronizing..."
  uri = URI.parse("http://localhost:8081/getList")
  masterList = []
  Net::HTTP.start(uri.host, uri.port) do |http|
    http.get(uri.request_uri, auth.getAuthHash().merge( {"content-type" => "plain/text"} )) { |str|
      masterList = str.split( /\n/ )
    }
  end
  # open local db
  localdb = PasteHub::LocalDB.new( LOCALDB_PATH )
  localdb.open( auth.username )

  # calc difference between master and local.
  localList = localdb.getList() 
  util = PasteHub::Util.new
  downList = util.diffList( masterList, localList ).reject{|x| x.match( /^_/ )}
  upList   = util.diffList( localList, masterList ).reject{|x| x.match( /^_/ )}

  # donwload
  downList.each {|key|
    value = getValue( auth, key )
    localdb.insertValue( key.dup, value.dup )
  }
  # upload
  upList.each {|key|
    value = localdb.getValue( key )
    putValue( auth,      key.dup, value.dup )
  }

  puts "Info: download #{downList.size} records."
  puts "Info:   upload #{upList.size} records."

  if 0 < downList.size
    localdb.insertValue( PasteHub::LATEST_DATE_KEY, util.currentTime( ) )
  end

  localdb.close()
end

def record_exist?( username, key )
  # open local db
  localdb = PasteHub::LocalDB.new( LOCALDB_PATH )
  localdb.open( username )
  ret = localdb.getValue( key, nil )
  localdb.close()
  ret
end

def setOnlineState( username, online )
  # open local db
  localdb = PasteHub::LocalDB.new( LOCALDB_PATH )
  localdb.open( username )
  localdb.insertValue( PasteHub::ONLINE_STATE_KEY, online ? "1" : "0" )
  localdb.close()
end

def wait_notify( auth )
  begin
    uri = URI.parse("http://localhost:8080/")
    Net::HTTP.start(uri.host, uri.port) do |http|
      request = Net::HTTP::Get.new(uri.request_uri, auth.getAuthHash())
      http.request(request) do |response|
        raise 'Response is not chuncked' unless response.chunked?
        response.read_body do |chunk|
          key = chunk.chomp
          if record_exist?( auth.username, key )
            puts "Info: exist-key: #{key}"
          else
            puts "Info: sync-key:  #{key}"
            return chunk.chomp
          end
        end
        if "200" != response.code
          STDERR.puts "Error: request error result=[#{response.code}]"
          return :retry
        end
      end
    end
  rescue EOFError => e
    STDERR.puts "Error: disconnected by server."
    return :retry
  rescue Errno::ECONNREFUSED => e
    STDERR.puts "Error: can't connect server."
    return :retry
  rescue Timeout::Error => e
    return :timeout
  end
end


def main
  username  = ENV['PASTEHUB_USER']
  if not username 
    STDERR.puts( "clientSync needs environment var `PASTEHUB_USER'" )
    exit 1
  end

  secretKey = ENV['PASTEHUB_SECRET_KEY']
  if not secretKey
    STDERR.puts( "clientSync needs environment var `PASTEHUB_SECRET_KEY'" )
  end

  setOnlineState( username, false )
  while true
    auth = PasteHub::AuthForClient.new( username, secretKey )
    result = wait_notify( auth )
    case result
    when :timeout
      STDERR.puts "waiting..."
      setOnlineState( username, true )
    when :retry
      STDERR.puts "retrying...."
      sleep 60
    else
      sync_db( auth )
    end
  end
end

main

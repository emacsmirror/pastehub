#!/usr/bin/env ruby
# -*- coding: utf-8 -*-

require 'pastehub'
PasteHub::Config.instance.loadClient

POLLING_INTERVAL    = 0.5

def main
  username  = ENV['PASTEHUB_USER']
  if not username 
    STDERR.puts( "pastehub-clientOSX needs environment var `PASTEHUB_USER'" )
    exit 1
  end

  secretKey = ENV['PASTEHUB_SECRET_KEY']
  if not secretKey
    STDERR.puts( "pastehub-clientOSX needs environment var `PASTEHUB_SECRET_KEY'" )
  end

  while true
    sleep POLLING_INTERVAL
    data = PasteHub::MacOSX.hasNew?( username )
    if data
      auth = PasteHub::AuthForClient.new( username, secretKey )
      client = PasteHub::Client.new( auth )
      if client.online?(  )
        STDERR.puts( "Info: posted data from MacOS X." )
        client.postData( data )
      else
        client.localSaveValue( data )
      end
    end
  end
end

main

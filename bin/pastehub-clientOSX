#!/usr/bin/env ruby
# -*- coding: utf-8 -*-

require 'pastehub'
PasteHub::Config.instance.loadClient

POLLING_INTERVAL    = 0.5

def osxHasNew?( username )
  osxPaste = open( "|/usr/bin/pbpaste" ) { |f| 
    f.read
  }

  # read top data of localDB
  begin
    store = PasteHub::LocalStore.new( username, true )
    top = store.top( )
    store.close()
  rescue RuntimeError
    # alreay opened the localStore
    top = ""
  end

  if 0 == osxPaste.size or 0 == top.size
    nil
  elsif osxPaste != top
    osxPaste
  else
    nil
  end
end

def pushData( data )
  begin
    IO.popen("pastehub-clientPost", "r+") {|io|
      STDERR.puts "Info: post from MacOS X clipboard."
      io.write data
      io.close
    }
  rescue IOError => e
    STDERR.puts( "Error: program pastehub-clientPost not found." )
    return false
  end
end


def main
  username  = ENV['PASTEHUB_USER']
  if not username 
    STDERR.puts( "pastehub-clientOSX needs environment var `PASTEHUB_USER'" )
    exit 1
  end

  while true
    sleep POLLING_INTERVAL
    data = osxHasNew?( username )
    if data
      pushData( data )
    end
  end
end

main

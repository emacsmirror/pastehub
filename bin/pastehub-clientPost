#!/usr/bin/env ruby
# -*- coding: utf-8 -*-

require 'net/http'
require 'uri'
require 'open-uri'
require 'fileutils'
require 'pastehub'

SERVER_HOST='localhost'
LOCALDB_PATH=File.expand_path( "~/.localdb/" ) + "/"

def postData( auth, data )
  begin
    uri = URI.parse("http://#{SERVER_HOST}:8081/insertValue")
    Net::HTTP.start(uri.host, uri.port) do |http|
      http.post(uri.request_uri, data, auth.getAuthHash().merge( {"content-type" => "plain/text"} )) { |str|
        puts str
      }
    end
  rescue Errno::ECONNREFUSED => e
    STDERR.puts "Error: can't connect server."
  end
end

def online?( username )
  # open local db
  localdb = PasteHub::LocalDB.new( LOCALDB_PATH )
  localdb.open( username, true )
  printf( "[%s]", localdb.getValue( PasteHub::ONLINE_STATE_KEY ))
  ret = ("1" == localdb.getValue( PasteHub::ONLINE_STATE_KEY ))
  localdb.close()
  ret
end

def saveValue( username, data )
  # open local db
  util = PasteHub::Util.new( )
  key = util.currentTime( ) + "=" + util.digest( data )

  localdb = PasteHub::LocalDB.new( LOCALDB_PATH )
  localdb.open( username )
  localdb.insertValue( key, data.dup )
  localdb.close()
end

def main
  username  = ENV['PASTEHUB_USER']
  if not username 
    STDERR.puts( "clientSync needs environment var `PASTEHUB_USER'" )
    exit 1
  end

  secretKey = ENV['PASTEHUB_SECRET_KEY']
  if not secretKey
    STDERR.puts( "clientSync needs environment var `PASTEHUB_SECRET_KEY'" )
  end

  data = STDIN.read
  if online?( username )
    auth = PasteHub::AuthForClient.new( username, secretKey )
    postData( auth, data )
  else
    saveValue( username, data )
  end
end

main

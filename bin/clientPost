#!/usr/bin/env ruby
# -*- coding: utf-8 -*-

require 'net/http'
require 'uri'
require 'open-uri'
require 'fileutils'
require 'synchrobase'
require 'json'

SERVER_HOST='localhost'

def postData( auth, data )
  begin
    uri = URI.parse("http://#{SERVER_HOST}:8081/insertValue")
    Net::HTTP.start(uri.host, uri.port) do |http|
      http.post(uri.request_uri, data, auth.getAuthHash().merge( {"content-type" => "plain/text"} )) { |str|
        puts str
      }
    end
  rescue Errno::ECONNREFUSED => e
    STDERR.puts "Error: can't connect server."
  end
end

def main
  username  = ENV['SYNC_USER']
  if not username 
    STDERR.puts( "clientSync needs environment var `SYNC_USER'" )
    exit 1
  end

  secretKey = ENV['SYNC_SECRET_KEY']
  if not secretKey
    STDERR.puts( "clientSync needs environment var `SYNC_SECRET_KEY'" )
  end

  data = STDIN.read
  auth = SynchroBase::AuthForClient.new( username, secretKey )
  postData( auth, data )
end

main
